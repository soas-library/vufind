<? 
if($this->driver->getCollectionType()[0] == "SOAS Library")
	$collectionType = $this->driver->userPermissions('OLE');
else if($this->driver->getCollectionType()[0] == "SOAS Research Online")
	$collectionType = $this->driver->userPermissions('ePrints');
?>
<?
  if($loggedin = $this->auth()->isLoggedIn()) {
	$user_id = $loggedin->id;
	$loggedin = true;
  } else {
	$user_id = false;
  }

  $formatRoles = function ($roles) {
	if (count($roles) == 0) {
	  return '';
	}
	$that = $this;
	$translate = function ($str) use ($that) {
	  return $that->transEsc('CreatorRoles::' . $str);
	};
	return ' (' . implode(', ', array_unique(array_map($translate, $roles))) . ')';
  };
?>
<div class="row" vocab="http://schema.org/" resource="#record" typeof="<?=$this->driver->getSchemaOrgFormats()?> Product">
  <? $QRCode = $this->record($this->driver)->getQRCode("core");
	 $cover = $this->record($this->driver)->getCover('core', 'medium', $this->record($this->driver)->getThumbnail('large'));
	 $preview = $this->record($this->driver)->getPreviews(); ?>
  <? if ($QRCode || $cover || $preview): ?>
  <div class="col-sm-3 img-col	hidden-xs">
	<div class="text-center">
	  <? /* Display thumbnail if appropriate: */ ?>
	  <? if($cover): ?>
		<?=$cover?>
	  <? endif; ?>

	  <? /* Display qrcode if appropriate: */ ?>
	  <? if($QRCode): ?>
		<span class="hidden-xs">
		  <br/><img alt="<?=$this->transEsc('QR Code')?>" class="qrcode" src="<?=$this->escapeHtmlAttr($QRCode);?>"/>
		</span>
	  <? endif; ?>
	</div>

	<? // if you have a preview tab but want to move or remove the preview link
	   // from this area of the record view, this can be split into
	   // getPreviewData() (should stay here) and
	   // getPreviewLink() (can go in your desired tab) ?>
	<? if ($preview): ?><?=$preview?><? endif; ?>
  </div>

  <div class="col-sm-9 info-col">
  <? else: ?>
  <div class="col-sm-12">
  <? endif; ?>

	<h3 property="name"><?=rtrim(trim($this->escapeHtml($this->driver->getShortTitle() . ' ' . $this->driver->getSubtitle() . ' ' . $this->driver->getTitleSection())),"/")?></h3>
	
	 <? $lnkTitle = $this->driver->getLinkedTitle();if (!empty($lnkTitle)): ?>
   
		  <? foreach($lnkTitle as $field): ?>
			<h4><?=$this->escapeHtml($field)?></h4>
		  <? endforeach; ?>

	  <? endif; ?> 

	<? if ($this->userlist()->getMode() !== 'disabled'): ?>
	  <? /* Display the lists that this record is saved to */ ?>
	  <div class="savedLists hidden alert alert-info">
		<strong><?=$this->transEsc("Saved in")?>:</strong>
	  </div>
	<? endif; ?>
   
	<?
	// Set up convenience variables:
	$account = $this->auth()->getManager();
	$user = $account->isLoggedIn();
	$holdings = $this->driver->getRealTimeHoldings();
	$offlineMode = $this->ils()->getOfflineMode();
	// Account for replace_other_urls setting
	$openUrl = $this->openUrl($this->driver, 'record');
	$openUrlActive = $openUrl->isActive();
	// Account for replace_other_urls setting
	$urls = $this->record($this->driver)->getLinkDetails($openUrlActive);
	$count_holdings=0;
   ?>
   
<!-- HOLDINGS AND ITEMS BOX -->
   
<div class="holdings">
<? $offsite = false;?>

<!-- SERIALS: DISPLAY SERIALS HOLDINGS (866) -->
	<? $journalholdings = $this->driver->getJournalHoldings(); if (!empty($journalholdings)): ?>
		<table class="table table-responsive" summary="<?=$this->transEsc('Journal holdings details')?>">
		<? foreach($journalholdings as $field): ?>
			<tr>
				<td><?=$this->escapeHtml($field)?><br/>
				</td>
			</tr>
		<? endforeach; ?>
		</table>
		<?$showOnOrder = false;?>
	<? endif; ?>
<!-- END SERIALS -->

<!-- INTERNET RECORDS: DISPLAY URL (856u or 555u) -->
	<? if (!empty($urls) || $openUrl): ?>
		<table class="table table-responsive" summary="<?=$this->transEsc('Holdings details from')?> <?=$this->transEsc("Internet")?>">
			<tr>
			<? $accessnote = $this->driver->getNote(); if (!empty($accessnote)): ?>
				<? foreach ($accessnote as $field): ?>
					<?if (stripos($field, 'SOAS') !== false): ?>
						<td><i><?= $this->escapeHtml($field)?></i>
						</td>
					<? endif; ?>
				<? endforeach; ?>
			<? endif; ?>
  
		<? if (!empty($urls)): ?>
			<? foreach ($urls as $current): ?>
				<? if($this->driver->getRegExpr($this->escapeHtml($current['desc']), $collectionType,$this->driver->getCollectionType()[0])): ?>										  
					<tr>
						<td>
							<a href="<?=$this->escapeHtmlAttr($this->proxyUrl($current['url']))?>"><?=($current['url'] == $current['desc']) ? $this->transEsc('Get full text') : $this->escapeHtml($current['desc'])?></a>
						</td>
					</tr>
				<? else: ?>
					<tr>
						<td><?=$this->transEsc("Not available")?></td>
					</tr>
				<? endif; ?>
			<? endforeach; ?>
		<? endif; ?>
		<? if ($openUrlActive): ?>
			<?=$openUrl->renderTemplate()?><br/>
		<? endif; ?>
		</table>
	<? endif; ?>
<!-- END INTERNET -->

<!-- SCB Change -->
	<? $hasItems=0;?>
	<? $hasHoldings=0;?>
	<? $hasCallnumber=0;?>
	<? $scbitems = $this->driver->getComplete947();?>

			<?
			$holdingClassmark=array();
			$holdingShelflist=array();
			foreach($scbitems as $index => $elem) {
				   if(strpos($index,'holding')!== false){
					   if (!empty($elem['classmark'])) $holdingClassmark[]=$elem['classmark'];
					   if (!empty($elem['shelflist'])) $holdingShelflist[]=$elem['shelflist'];
				   }
			   }
			
			?>

<!-- BIBS WITH ITEMS: DISPLAY ITEM LOCATION (947l), ITEM CLASSMARK (947a), ITEM LOAN TYPE (MYSQL), ITEM STATUS (MYSQL) -->
			
	<? foreach ($holdings as $holding): ?>
		<table class="table table-responsive" summary="<?=$this->transEsc('Holdings details from')?> <?=$this->transEsc($holding['location'])?>">
			<? if (!empty($holding['summary'])): ?>
				<tr>
					<th><?=$this->transEsc("Volume Holdings")?>: </th>
					<td>
						<? foreach ($holding['summary'] as $current): ?>
							<?=$this->escapeHtml($current)?><br/>
						<? endforeach; ?>
					</td>
				</tr>
			<? endif; ?>
			<? if (!empty($holding['notes'])): ?>
				<tr>
					<th><?=$this->transEsc("Notes")?>: </th>
					<td>
						<? foreach ($holding['notes'] as $data): ?>
							<?=$this->escapeHtml($data)?><br/>
						<? endforeach; ?>
					</td>
				</tr>
			<? endif; ?>
  
			<?
				$class_txt = "";
			?>

			<!-- SCB Change Sorting by enumeration-->
			<? 
				$aux=array();
				$withsort = array();
				foreach ($holding['items'] as $elem) {
					$enumerationText=$elem['enumeration'];
					preg_match('/\(.*\)/', $enumerationText,$arAux);  
					foreach($arAux	as $varAux){
						$varAux = str_replace('(','',$varAux); 
						$varAux = str_replace(')','',$varAux);
						$varAux= preg_replace('/\d/', '', $varAux).substr("0000000000". preg_replace('/[^0-9]+/', '', $varAux),-10);
					}

					//	 $elem['sorted']=  $elem['callnumber']. " ". preg_replace('/\d/', '', $enumerationText).substr("0000000000". preg_replace('/[^0-9]+/', '', preg_replace('/\(.*\)/', '', $enumerationText)),-10);
					$elem['sorted']=  $elem['callnumber']. " ". str_replace(' ','',preg_replace('/\d/', '', preg_replace('/\(.*\)/', '', $enumerationText))).substr("0000000000". preg_replace('/[^0-9]+/', '', preg_replace('/\(.*\)/', '', $enumerationText)),-10) . $varAux;
					$withsort[]=$elem;
				}
				$holding['items']=$withsort;
  
				foreach ($withsort as $key => $fila) {
					$aux[$key] = $fila['sorted'];
				}

				array_multisort($aux, SORT_ASC, $withsort);	   
   
				$holding['items'] = $withsort;
			?>

			<!-- SCB Change Sorting by enumeration-->
			<?$showOnOrder= false;?>
			<? foreach ($holding['items'] as $row): ?>
				<?$unavailable = false;?>
				<? $check = (isset($row['check']) && $row['check']); ?>
				<? $checkStorageRetrievalRequest = (isset($row['checkStorageRetrievalRequest']) && $row['checkStorageRetrievalRequest']); ?>
				
				<? if (array_key_exists("barcode",$row)): ?>
					<!-- SCB Change -->
					<?$count_holdings=$count_holdings+1;?>
					<?if($count_holdings > 6)
						$class_txt="class='hidden_holdings'";
					else
						$class_txt="class='hidden_holdings2'";
					?>
					<!--SCB-2017/11/23 Show only once order text-->
					<? if (strpos($row['status'],'ONORDER') !== false):?>
						<?$showOnOrder= true;?>
						<?$class_txt=$class_txt.'hidden';?>
					<? endif; ?>
 
					<? $hasItems=1;?>
					<tr <?echo $class_txt;?> vocab="http://schema.org/" typeof="Offer">
						
						<!-- BIB LOCATION LINK -->
						
						<? if ($row['holdings']): ?>
						<td class="hidden-xs3">
							<?=$this->escapeHtml($row['holdings'])?>
						</td>
						<? endif; ?>

						<? $barcode= $row['barcode'];
						$item= $scbitems[$barcode]; ?>
						<? if(empty($item['location'])):?>
							<? $place=$row['location']?>
						<? elseif($row['location']!=="MAIN"):?>
							<? $place=$row['location']?>
						<? else:?>
							<? $place=$item['location']?>
						<? endif;?>
			
						<!--SCB LocationList -->		
						<? $barcode= $row['barcode'];
							$item= $scbitems[$barcode]; 
						?>		
						<? if ($item['shelflist']): ?> 
							<?$classmarkLocationList=$this->escapeHtml($item['shelflist']);?>
						<? else:?>
							<? if (!empty($holdingClassmark[0])):?> 
								<?$classmarkLocationList=$this->escapeHtml($holdingClassmark[0]);?>
							<? else:?>
							<?$classmarkLocationList=$this->escapeHtml($row['callnumberDisplay']);?>
							<? endif;?>
						<? endif; ?>
						<!-- END SCB LocationList --> 

						<? if (stripos($place, 'Main') !== false): ?>
							<? $place = "..." ;?>
							<? $shelflocation = $this->driver->getShelfLocation();?>
							<? if (empty($item['classmark'])): ?>
								<? if (!empty($holdingShelflist[0])):?>
									<td class="hidden-xs4 default_table_width"><a target="_blank" href="/Locationlist?ll=<?=$this->escapeHtml($holdingShelflist[0]);?>&cm=<?=$classmarkLocationList;?>"><?=$this->escapeHtml($holdingShelflist[0]);?></a></td>
								<? else:?>
									<? if (!empty($shelflocation)): ?>
										<? foreach ($shelflocation as $location): ?>
											<td class="hidden-xs4 default_table_width"><a target="_blank" href="/Locationlist?ll=<?=$this->escapeHtml($location);?>&cm=<?=$classmarkLocationList;?>"><?=$this->escapeHtml($location);?></a></td>
										<? endforeach; ?>
									<? else: ?>
										<td class="hidden-xs4 default_table_width"><a target="_blank" href="/Locationlist?ll=<?=$this->escapeHtml($place);?>&cm=<?=$classmarkLocationList;?>"><?=$this->escapeHtml($place);?></a></td>
									<? endif; ?>
								<? endif;?>
							<? else:?>
								<td class="hidden-xs5 default_table_width"><a target="_blank" href="/Locationlist?ll=<?=$item['classmark'];?>&cm=<?=$classmarkLocationList;?>"><?=$this->escapeHtml($place);?></a></td>
							<? endif; ?>

						<? else:?>				 
							<td class="hidden-xs6 default_table_width"> 
								<?$place_link="/Locationlist?cm=".$classmarkLocationList;
									if($place=="Archive & Special Collections")
										$place_link="/Locationlist?ll=Archives xxxxx Special Collections&cm=".$classmarkLocationList;
									else if($place=="Closed Access, ask at Issue Desk"){
										$place = "Closed access";
										$place_link="/Locationlist?ll=Closed Access&cm=".$classmarkLocationList;
									}
									else if($place=="MOBILE"){
										$place = "Mobile stacks, Level F";
										$place_link="/Locationlist?ll=Level F&cm=".$classmarkLocationList;
									}
									else if($place=="SCRR"){
										$place = "Archive & Special Collections";
										$place_link="/Locationlist?ll=Archives xxxxx Special Collections&cm=".$classmarkLocationList;
									}
									else if($place=="Jewish Music Institute"){
										$place_link="/Locationlist?ll=jmi&cm=".$classmarkLocationList;
									}
									else if ($place=="CURRENTLY UNAVAILABLE")
										$unavailable = true;
								?>		 
								<? if($place=="Archive & Special Collections"):?>
									<script>
										document.getElementById("sms-record").href = "https://www.soas.ac.uk/library/archives/services/requesting-material/orders/";
										document.getElementById("sms-record").innerHTML = '<i class="fa fa-share"></i> <?=$this->transEsc("Order archive material")?>';
										$("#sms-record").removeAttr("data-lightbox");
										document.getElementById("sms-record").target = "_blank";
									</script>
								<? endif;?>
								<?if(stripos($place, 'OFFSITE') !== false): 
									$place_link="/Locationlist?ll=OFFSITE&cm=".$classmarkLocationList;
								endif;?>	   
								<? if (stripos($place, 'RAINHAM') !== false | stripos($place, 'EGHAM') !== false): ?>
									<?$place= 'Offsite';
										$place_link="/Locationlist?ll=OFFSITE";
									?>
								<? endif; ?>
								<?if($unavailable):?>
									<?=$place;?>
								<?else:?>
									<a target="_blank"	href="<?=$place_link;?>"><?=$place;?></a>
								<?endif;?>
							</td>
						<? endif; ?>
						
						<!-- END BIB LOCATION -->
						
						<!-- BIB CLASSMARK -->
						
						<td class="hidden-xs7 barc_table_width">
							<? $barcode= $row['barcode'];
								$item= $scbitems[$barcode]; ?>
		
							<strong class="hidden"><?=$this->transEsc("Call Number")?>:</strong> 
							<? if ($item['shelflist']): ?>
								<a href="/Alphabrowse/Home?source=callnumber&from=<?=$this->escapeHtml($item['shelflist'])?>"><?=$this->escapeHtml($item['shelflist'])?></a> <?=$this->escapeHtml($item['enumeration'])?>
							<? else:?>
								<? if (!empty($holdingClassmark[0])):?> 
									<a href="/Alphabrowse/Home?source=callnumber&from=<?=$this->escapeHtml($holdingClassmark[0])?>"><?=$this->escapeHtml($holdingClassmark[0])?> </a><?=$this->escapeHtml($row['enumeration'])?>
								<? else:?>
									<a href="/Alphabrowse/Home?source=callnumber&from=<?=$this->escapeHtml($row['callnumberDisplay'])?>"><?=$this->escapeHtml($row['callnumberDisplay'])?> </a><?=$this->escapeHtml($row['enumeration'])?>
								<? endif;?>
							<? endif; ?>
						</td>

						<!-- END BIB CLASSMARK -->
						
						<!-- BIB LOAN TYPE -->
						
						<td class="hidden-xs9">
							<script>
								$(document).ready(function(){
								$("#tooltip-ex a").tooltip({
								placement : 'top'
								});
								});
							</script>
							<? if ($row['type']): ?>
								<? if (stripos($row['type'], 'LONG LOAN') !== false): ?>
									<div id="tooltip-ex">
										<a href="#" data-toggle="tooltip" data-original-title="<?=$this->transEsc("Anyone with SOAS Library membership can borrow this item type")?>"><?=$this->escapeHtml($row['type'])?></a>
									</div>
								<? elseif (stripos($row['type'], 'ONE WEEK LOAN') !== false): ?>
									<div id="tooltip-ex">
										<a href="#" data-toggle="tooltip" data-original-title="<?=$this->transEsc("Only SOAS staff and students can borrow this item type")?>"><?=$this->escapeHtml($row['type'])?></a>
									</div>
								<? elseif (stripos($row['type'], 'THREE DAY LOAN') !== false): ?>
									<div id="tooltip-ex">
										<a href="#" data-toggle="tooltip" data-original-title="<?=$this->transEsc("Only SOAS staff and students can borrow this item type")?>"><?=$this->escapeHtml($row['type'])?></a>
									</div>
								<? elseif (stripos($item['type'], 'SHORT') !== false): ?>
									<div id="tooltip-ex">
										<a href="#" data-toggle="tooltip" data-original-title="<?=$this->transEsc("Only SOAS staff and students can borrow this item type")?>"><?=$this->escapeHtml($item['type'])?></a>
									</div>
								<? elseif (stripos($row['type'], 'REFERENCE ONLY') !== false): ?>
									<div id="tooltip-ex">
										<a href="#" data-toggle="tooltip" data-original-title="<?=$this->transEsc("Only for use in the library")?>"><?=$this->escapeHtml($row['type'])?></a>
									</div>
								<? else: ?>
									<?=$this->escapeHtml($row['type'])?>
								<? endif; ?>
							<? endif; ?>
						</td>
						
						<!-- END BIB LOAN TYPE -->
						
						<!-- BIB COLLECTION -->
						
						<? if (!empty($row['collection'])): ?>
							<td class="hidden-xs10">
								<?=$this->escapeHtml($row['collection'])?>
							</td>
						<? endif; ?>

						<!-- END BIB COLLECTION -->
						
						<!-- BIB AVAILABILITY STATUS -->
						
						<td class="hidden-xs11">
							<?if(!$unavailable):?>
								<? if ($row['reserve'] == "Y"): ?>
									<link property="availability" href="http://schema.org/InStoreOnly" />
									<?=$this->transEsc("On Reserve - Ask at Circulation Desk")?><br />
								<? endif; ?>
								<? if (isset($row['use_unknown_message']) && $row['use_unknown_message']): ?>
									<span class="muted"><?=$this->transEsc("status_unknown_message")?></span>
								<? else: ?>
									<? if ($row['availability']): ?>
										<? /* Begin Available Items (Holds) */ ?>
										<span class="text-success"><?=$this->transEsc($row['status'])?><link property="availability" href="http://schema.org/InStock" /></span>
										<? if (isset($row['link']) && $row['link']): ?>
											<a style="display:inline-block" class="<?=$check ? 'checkRequest ' : ''?>inlineblock modal-link placehold" href="<?=$this->recordLink()->getRequestUrl($row['link'])?>" title="<?=$this->transEsc($check ? "Check Hold" : "Place a Hold")?>"><i class="icon-flag"></i>&nbsp;<?=$this->transEsc($check ? "Check Hold" : "Place a Hold")?></a>
										<? endif; ?>
										<? if (isset($row['storageRetrievalRequestLink']) && $row['storageRetrievalRequestLink']): ?>
											<a class="<?=$checkStorageRetrievalRequest ? 'checkStorageRetrievalRequest ' : ''?>modal-link placeStorageRetrievalRequest" href="<?=$this->recordLink()->getRequestUrl($row['storageRetrievalRequestLink'])?>" title="<?=$this->transEsc($checkStorageRetrievalRequest ? "storage_retrieval_request_check_text" : "storage_retrieval_request_place_text")?>"><i class="icon-flag"></i>&nbsp;<?=$this->transEsc($checkStorageRetrievalRequest ? "storage_retrieval_request_check_text" : "storage_retrieval_request_place_text")?></a>
										<? endif; ?>
									<? else: ?>
										<? /* Begin Unavailable Items (Recalls) */ ?>
										<span class="text-danger"><?=$this->transEsc($row['status'])?><link property="availability" href="http://schema.org/OutOfStock" /></span>
										<? if (isset($row['returnDate']) && $row['returnDate']): ?>
											&ndash; <span class="small"><?=$this->escapeHtml($row['returnDate'])?></span>
										<? endif; ?>
										<? if (isset($row['duedate']) && $row['duedate']): ?>
											&ndash; <span class="text-danger"><?=$this->transEsc("Due")?>: <?=$this->escapeHtml($row['duedate'])?></span>
										<? endif; ?>
										<? if (isset($row['requests_placed']) && $row['requests_placed'] > 0): ?>
											<span><?=$this->transEsc("Requests")?>: <?=$this->escapeHtml($row['requests_placed'])?></span>
										<? endif; ?>
										<? if ((stripos($row['status'], 'On loan') !== false) || (stripos($row['status'], 'On holdshelf') !== false)) : ?>
											<? if (isset($row['link']) && $row['link']): ?>
												<a class="<?=$check ? 'checkRequest' : ''?> modal-link inlineblock placehold" href="<?=$this->recordLink()->getRequestUrl($row['link'])?>">&nbsp;<i class="fa fa-flag"></i>&nbsp;<?=$this->transEsc($check ? "Check Recall" : "Recall")?></a>
											<? endif; ?>
										<? endif; ?>
									<? endif; ?>
								<? endif; ?>
							<?else:?>
								<span class="text-danger"><?=$this->transEsc("Unavailable")?><link property="availability" href="http://schema.org/OutOfStock" /></span>
							<?endif;?>

							<? /* Embed item structured data: library, barcode, call number */ ?>
							<? if ($row['location']): ?>
								<meta property="seller" content="<?=$this->escapeHtml($row['location'])?>" />
							<? endif; ?>
							<? if ($row['barcode']): ?>
								<meta property="serialNumber" content="<?=$this->escapeHtml($row['barcode'])?>" />
							<? endif; ?>
							<? if ($row['callnumberDisplay']): ?>
								<meta property="sku" content="<?=$this->escapeHtml($row['callnumberDisplay'])?>" />
							<? endif; ?>
							<? /* Declare that the item is to be borrowed, not for sale */ ?>
							<link property="businessFunction" href="http://purl.org/goodrelations/v1#LeaseOut" />
							<link property="itemOffered" href="#record" />
						</td>
						
						<!-- END BIB AVAILABILITY STATUS -->
	
						<!-- BIB USER'S POSITION IN QUEUE -->
	
						<!--Changes by htc ** Start -->
						
						<? if ($row['ptrn_q_pos']): ?>	
							<td class="hidden-xs12">
								<? if (stripos($row['ptrn_q_pos'],'0') !== false): ?>
									<!--Do Nothing -->
								<? else: ?>
									<strong class="hidden-xs13"><?=$this->transEsc("Queue Position")?>:</strong> <?=$this->escapeHtml($row['ptrn_q_pos'])?>
								<? endif; ?>
							<?elseif($row['req_count']): ?>
								<? if (stripos($row['status'], 'Available') !== false) : ?>
								<!--Do Nothing -->
								<? else: ?>
									<!--<?=$this->transEsc("+")?> <?=$this->escapeHtml($row['req_count'])?>-->
									***<?=$this->transEsc(" Item has more than one reservation")?>***
								<? endif; ?>
							</td>
						<? endif; ?>
						<!--End -->
					</tr>
				<? endif; ?>
			<? endforeach; ?>

			<? if (!empty($holding['purchase_history'])): ?>
				<tr>
					<th><?=$this->transEsc("Most Recent Received Issues")?>:</th>
					<td>
						<? foreach ($holding['purchase_history'] as $current): ?>
							<?=$this->escapeHtml($current['issue'])?><br/>
						<? endforeach; ?>
					</td>
				</tr>
			<? endif; ?>
		</table>
	<? endforeach; ?>
	
	<!-- ON ORDER STATUS -->
	
	<? $format = $this->driver->getFormats(); ?>
	<? if ($format[0] != "Journal"): ?>
		<? if ($showOnOrder):?>
			<span class="onOrder"><?=$this->transEsc("On order")?></span>
		<? endif; ?>
	<? endif; ?>
	
	<!-- END ON ORDER STATUS -->

<!-- END BIB WITH ITEMS -->	

<!-- BIB WITH NO ITEMS, ONLY HOLDINGS: DISPLAY HOLDINGS LOCATION (946$l) AND HOLDINGS CLASSMARK (946$a) -->
	
<!-- When there are no items (947) we display the (946) -->
	<? $item_information = $this->driver->getItemInformation(); if (empty($item_information)): ?>
		<? $holdings_information = $this->driver->getHoldingsInformation(); if (!empty($holdings_information)): ?>
			<table class="table table-responsive" summary="<?=$this->transEsc('Holdings details')?> ">
				<? foreach ($holdings_information as $field): ?>
					<? $holdings = explode(" : ",$field); ?>
					<tr vocab="http://schema.org/" typeof="Offer">
						<td>
							<? if($holdings[0]=="Archive & Special Collections"): ?>
								<a target="_blank" href="/Locationlist?ll=Archives xxxxx Special Collections&cm=<?=$this->escapeHtml($holdings[1])?>"><?=$holdings[0];?></td>
							<? elseif($holdings[0]=="Closed access"): ?>
								<a target="_blank" href="/Locationlist?ll=Closed Access&cm=<?=$this->escapeHtml($holdings[1])?>"><?=$holdings[0];?></td>
							<? elseif($holdings[0]=="Mobile stacks, Level F"): ?>
								<a target="_blank" href="/Locationlist?ll=Level F&cm=<?=$this->escapeHtml($holdings[1])?>"><?=$holdings[0];?></td>
							<? else: ?>
								<a target="_blank" href="/Locationlist?ll=<?=$holdings[0];?>&cm=<?=$this->escapeHtml($holdings[1])?>"><?=$holdings[0];?></td>
							<? endif; ?>
						</td>
						<td>
							<strong class="hidden"><?=$this->transEsc("Call Number")?>:</strong> 
							<? if ($holdings[1]): ?> 
								<a href="/Alphabrowse/Home?source=callnumber&from=<?=$this->escapeHtml($holdings[1])?> <?=$this->escapeHtml($holdings[2])?>"><?=$this->escapeHtml($holdings[1])?> <?=$this->escapeHtml($holdings[2])?></a>
							<? endif; ?>
						</td>
					</tr>
				<? endforeach; ?>
			</table>
		<? endif; ?>
	<? endif; ?>
	
<!-- END BIB WITH NO ITEMS, ONLY HOLDINGS -->

<!-- BIB WITH NO ITEMS, NO HOLDINGS -->
	
<!-- When there are no items (947) or holdings (946) we display the 082 (but not for Journals)-->

<!--SCB-2017/11/23 do not show classsmark-->
	<? if ($hasItems<1 && $hasHoldings<1 && false) : ?>
		<? $callnumber = $this->driver->getClassmark();?>
		<? $checkFormat =  $this->driver->getFormats(); ?>
		<? $shelfLocations = $this->driver->getShelfLocation();?>	 
		<?$hasCallnumber=1;?>
		<table class="table table-responsive" summary="<?=$this->transEsc('Holdings details from')?> <?=$this->transEsc($callnumber)?>">
			<tr vocab="http://schema.org/" typeof="Offer">
				<?if (count($shelfLocations)>0 && !$offsite) :?>
					<td><a target="_blank" href="/Locationlist?ll=<?=$shelfLocations[0];?>&cm=<?=$this->escapeHtml($callnumber)?>"><?=$shelfLocations[0];?></td>
				<?endif;?>
				<?if (!(in_array("eBook", $checkFormat))) :?>
					<td>
						<strong class="hidden"><?=$this->transEsc("Call Number")?>:</strong> <? if ($callnumber): ?> <a href="/Alphabrowse/Home?source=callnumber&from=<?=$this->escapeHtml($callnumber)?>"><?=$this->escapeHtml($callnumber)?></a><? endif; ?>
					</td>
				<?endif;?>
			</tr>
		</table>
	<? endif; ?>
	
<!-- END BIB WITH NO ITEMS, NO HOLDINGS -->
	
<!-- UNCLEAR, SHOW ON ORDER STATUS? -->
<?if (($hasItems<1 && $hasHoldings<1) || !$showOnOrder /*&& $hasCallnumber<1*/) :?>
	<? $onOrderItem = $this->driver->getItemOnOrder();?>
	<? if(count($onOrderItem)>0) :?>
		<table class="table table-responsive" summary="<?=$this->transEsc('Holdings details from')?> <?=$this->transEsc($callnumber)?>">
			<tr vocab="http://schema.org/" typeof="Offer">
				<td>
					<?$showOnOrderAux =false;
						foreach($onOrderItem as $aux){
							if (strpos($aux,'ONORDER') !== false)
								$showOnOrderAux = true;
						}
					?>
					<? $formats = $this->driver->getFormats(); ?>
					<? if((strpos($formats[0],"Journal")) === false):?>
						<? if ($showOnOrderAux):?>
							<span class="onOrder">
								<?=$this->transEsc("On order")?>
							</span>
						<? endif; ?>
					<? endif; ?>
				</td>
			</tr>
		</table>
	<?endif;?>
<?endif;?>

<!-- END UNCLEAR -->

<!-- BIB WITH MORE THAN SIX ITEMS: SHOW 'DISPLAY ALL' LINK  -->

<?if($count_holdings > 6):?>
	<div id="div_show_more"><span onclick="showAllHoldings()"><?=$this->transEsc("DISPLAY ALL").' ...'?></span></div>
	<div id="div_show_less" class="hidden"><span onclick="showLessHoldings()"><?=$this->transEsc("SHOW LESS").' ...'?></span></div>
<?endif;?>

</div>

<!-- END HOLDINGS AND ITEMS BOX -->

<!-- MAIN DETAILS TABLE -->
	
   <?/* Display Main Details */?>
	<table class="table table-striped" summary="<?=$this->transEsc('Bibliographic Details')?>">
	
	  <? $statement = $this->driver->getStatement(); if (!empty($statement)): ?>
	  <tr>
		<th><?=$this->transEsc('Full Title')?>: </th>
		<td>
		  <? foreach($statement as $field): ?>
			<?=rtrim(trim($this->escapeHtml($field)),"/")?><br/>
		  <? endforeach; ?>
	<?$linkedstatement = $this->driver->getLinkedStatement(); if (!empty($linkedstatement)): ?>
		  <? foreach($linkedstatement as $field): ?>
			<?=$this->escapeHtml($field)?><br/>
		  <? endforeach; ?>
		<? endif; ?>
		</td>
	  </tr>
	  <? endif; ?>

	  <? $journalTitle = $this->driver->getContainerTitle(); if (!empty($journalTitle)): ?>
	  <tr>
		<th><?=$this->transEsc('Journal Title')?>:</th>
		<td>
		  <a href="<?=$this->record($this->driver)->getLink('journaltitle', $journalTitle)?>"><?=$this->escapeHtml($journalTitle)?></a>
		  <? $ref = $this->driver->getContainerReference(); if (!empty($ref)) { echo $this->escapeHtml($ref); } ?>
		</td>
	  </tr>
	  <? endif; ?>

		   <? $nextTitles = $this->driver->getNewerTitles(); $prevTitles = $this->driver->getPreviousTitles(); ?>
	  <? if (!empty($nextTitles)): ?>
	  <tr>
		<th><?=$this->transEsc('New Title')?>: </th>
		<td>
		  <? foreach($nextTitles as $field): ?>
			<a href="<?=$this->record($this->driver)->getLink('title', $field)?>"><?=$this->escapeHtml($field)?></a><br/>
		  <? endforeach; ?>
		</td>
	  </tr>
	  <? endif; ?>

	  <? if (!empty($prevTitles)): ?>
	  <tr>
		<th><?=$this->transEsc('Previous Title')?>: </th>
		<td>
		  <? foreach($prevTitles as $field): ?>
			<a href="<?=$this->record($this->driver)->getLink('title', $field)?>"><?=$this->escapeHtml($field)?></a><br/>
		  <? endforeach; ?>
		</td>
	  </tr>
	  <? endif; ?>
	  
	  <? $alttitle = $this->driver->getAltTitle(); if (!empty($alttitle)): ?>
	  <tr>
		<th><?=$this->transEsc('Alternative Titles')?>: </th>
		<td>
		  <? foreach($alttitle as $field): ?>
			<a href="<?=$this->record($this->driver)->getLink('title', $field)?>"><?=$this->escapeHtml($field)?></a><br/>
		  <? endforeach; ?>
		  <? $linkedalttitle = $this->driver->getLinkedTitleAlt(); if (!empty($linkedalttitle)): ?>
			<? foreach($linkedalttitle as $field): ?>
				<?=$this->escapeHtml($field)?><br/>
			<? endforeach; ?>
		  <? endif; ?>
		</td>
	  </tr>
	  <? endif; ?>

   <? $authors = $this->driver->getDeduplicatedAuthors(); ?>
	  <? if (isset($authors['main']) && !empty($authors['main'])): ?>
		<tr>
		  <th><?=$this->transEsc(count($authors['main']) > 1 ? 'Main Authors' : 'Main Author')?>: </th>
		  <td>
			<? $i = 0; foreach ($authors['main'] as $author => $roles): ?><?=($i++ == 0)?'':', '?><span property="author"><a href="<?=$this->record($this->driver)->getLink('author', $author)?>"><?=$this->escapeHtml($author)?></a><?=$formatRoles($roles)?></span></br><? endforeach; ?>
			
			<? $linkedauthor = $this->driver->getLinkedAuthor(); if (!empty($linkedauthor)): ?>
			<? foreach($linkedauthor as $field): ?>
			<a href="<?=$this->record($this->driver)->getLink('author', $field)?>"><?=$this->escapeHtml($field)?></a>
			<br />
			<? endforeach; ?>
		<? endif; ?>
		  </td>			 
		</tr>
	  <? endif; ?>

	 <? if (isset($authors['corporate']) && !empty($authors['corporate'])): ?>
		<tr>
		  <th><?=$this->transEsc(count($authors['corporate']) > 1 ? 'Corporate Author' : 'Corporate Authors')?>: </th>
		  <td>
			<? $i = 0; foreach ($authors['corporate'] as $corporate => $roles): ?><?=($i++ == 0)?'':', '?><span property="creator"><a href="<?=$this->record($this->driver)->getLink('author', $corporate)?>"><?=$this->escapeHtml($corporate)?></a><?=$formatRoles($roles)?></span></br><? endforeach; ?>
		  
		<? $linkedcorporate = $this->driver->getLinkedCorporate(); if (!empty($linkedcorporate)):?>
		 <? foreach ($linkedcorporate as $linkcorp): ?>
		 
		 <a href="<?=$this->record($this->driver)->getLink('author', $linkcorp)?>"><?= $this->escapeHtml($linkcorp)?></br>
		
		<?endforeach;?>
		<?endif;?>
	</td>
		</tr>
	  <? endif; ?>

	  <? if (isset($authors['secondary']) && !empty($authors['secondary'])): ?>
		<tr>
		  <th><?=$this->transEsc('Other Authors')?>: </th>
		  <td>
			<? $i = 0; foreach ($authors['secondary'] as $author => $roles): ?><?=($i++ == 0)?'':''?><span property="contributor"><a href="<?=$this->record($this->driver)->getLink('author', $author)?>"><?=$this->escapeHtml($author)?></a><?=$formatRoles($roles)?></span></br><? endforeach; ?>
		  
		  
		  <? $linkedauthor2 = $this->driver->getLinkedAuthor2(); if (!empty($linkedauthor2)): ?>
			<? foreach ($linkedauthor2 as $linkauthor): ?>
		   
			<a href="<?=$this->record($this->driver)->getLink('author', $linkauthor)?>"><?= $this->escapeHtml($linkauthor)?></a></br>
			
			<? endforeach; ?>
		<?endif;?>	
	   </td>  
		</tr>
	  <? endif; ?>

	<? $formats = $this->driver->getFormats(); if (!empty($formats)): ?>
		<tr>
		  <th><?=$this->transEsc('Format')?>: </th>
		  <td><?=str_replace('class="', 'class="label label-info ', $this->record($this->driver)->getFormatList())?>
				 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		   <?if($this->driver->getElectronic()== "Electronic"):?>
				<span class="label label-info iconlabel electronic"><?=$this->transEsc("Electronic")?></span>
		   <?endif;?>
		  </td>
		</tr>
	  <? endif; ?>
	  
	  <? $journalholdings = $this->driver->getJournalHoldings(); if (!empty($journalholdings)): ?>
		<tr valign="top">
		  <th><?=$this->transEsc('Holdings')?>: </th>
		  <td><? foreach ($journalholdings as $field): ?><?= $this->escapeHtml($field)?><br/><? endforeach; ?></td>
		</tr>
	  <? endif; ?>

 <!--	  <? $langs = $this->driver->getLanguages(); if (!empty($langs)): ?>
		<tr>
		  <th><?=$this->transEsc('Language')?>: </th>
		  <td><? foreach ($langs as $lang): ?><?= $this->escapeHtml($lang)?><br/><? endforeach; ?></td>
		</tr>
	  <? endif; ?>
	  
	   <? $publications = $this->driver->getPublicationDetails(); if (!empty($publications)): ?>
	  <tr>
		<th><?=$this->transEsc('Published')?>: </th>
		<td> 
		  <? foreach ($publications as $field): ?>
			<span property="publisher" typeof="Organization">
			<? $pubPlace = $field->getPlace(); if (!empty($pubPlace)): ?>
			  <span property="place"><?=$this->escapeHtml($pubPlace)?></span>
			<? endif; ?>
			<? $pubName = $field->getName(); if (!empty($pubName)): ?>
			  <span property="name"><?=$this->escapeHtml($pubName)?></span>
			<? endif; ?>
			</span>
			<? $pubDate = $field->getDate(); if (!empty($pubDate)): ?>
			  <span property="publicationDate"><?=$this->escapeHtml($pubDate)?></span>
			<? endif; ?>
			<br/>
		  <? endforeach; ?>
	  <? $linkedimprint = $this->driver->getLinkedImprint(); if (!empty($linkedimprint)): ?>
			  <? foreach ($linkedimprint as $field): ?><?= $this->escapeHtml($field)?><br/>
		  <? endforeach; ?>
		  <? endif; ?>
		</td>
	  </tr>
	  <? endif; ?>
	  -->
	   <? $edition = $this->driver->getEdition(); if (!empty($edition)): ?>
	  <tr>
		<th><?=$this->transEsc('Edition')?>: </th>
		<td property="bookEdition">
		<?=$this->escapeHtml($edition)?>
		<br />

	  <? $linkededition = $this->driver->getLinkedEdition(); if (!empty($linkededition)): ?>
		  <? foreach($linkededition as $field): ?>
			<?=$this->escapeHtml($field)?>
			<br />
		  <? endforeach; ?>
	  <? endif; ?>

	</td>
	  </tr>
	  <? endif; ?>

	  <?/* Display series section if at least one series exists. */?>
  <!--	  <? $series = $this->driver->getSeries(); if (!empty($series)): ?>
	  <tr>
		<th><?=$this->transEsc('Series')?>: </th>
		<td>
		  <? foreach ($series as $field): ?>
			<?/* Depending on the record driver, $field may either be an array with
			   "name" and "number" keys or a flat string containing only the series
			   name.  We should account for both cases to maximize compatibility. */?>
			<? if (is_array($field)): ?>
			  <? if (!empty($field['name'])): ?>
				<a href="<?=$this->record($this->driver)->getLink('series', $field['name'])?>"><?=$this->escapeHtml($field['name'])?></a>
				<? if (!empty($field['number'])): ?>
				  <?=$this->escapeHtml($field['number'])?>
				<? endif; ?>
				<br/>
			  <? endif; ?>
			<? else: ?>
			  <a href="<?=$this->record($this->driver)->getLink('series', $field)?>"><?=$this->escapeHtml($field)?></a><br/>
			<? endif; ?>
		  <? endforeach; ?>
		  
		  <? $linkedseries = $this->driver->getLinkedSeries(); if (!empty($linkedseries)): ?>
			<? foreach ($linkedseries as $linkseries): ?><a href="<?=$this->record($this->driver)->getLink('series', $field['name'])?>"><?= $this->escapeHtml($linkseries)?></a>
			   <? if (!empty($field['number'])): ?> ; <?=$this->escapeHtml($field['number'])?>
			   <? endif; ?><br/>
			<? endforeach; ?>
		  <? endif; ?>
		  
		</td>
	  </tr>
	  <? endif; ?>

	  <? $subjects = $this->driver->getAllSubjectHeadings(); if (!empty($subjects)): ?>
	  <tr>
		<th><?=$this->transEsc('Subjects')?>: </th>
		<td>  
		  <? foreach ($subjects as $field): ?>
		  <div class="subjectLine" property="keywords">
			<? $subject = ''; ?>
			<? if(count($field) == 1) $field = explode('--', $field[0]); ?>
			<? $i = 0; foreach ($field as $subfield): ?>
			  <?=($i++ == 0) ? '' : ' &gt; '?>
			  <? $subject = trim($subject . ' ' . $subfield); ?>
			  <a class="backlink" title="<?=$this->escapeHtmlAttr($subject)?>" href="<?=$this->record($this->driver)->getLink('subject', $subject)?>"><?=trim($this->escapeHtml($subfield))?></a>
			<? endforeach; ?>
		  </div>
		  <? endforeach; ?>
		  <? $linkedtopic = $this->driver->getLinkedTopic(); if (!empty($linkedtopic)): ?>
			<br />
			<? foreach ($linkedtopic as $linktopic): ?><a href="http://albert.lis.soas.ac.uk/Search/Results?lookfor=<?= $this->escapeHtml($linktopic)?>&type=Subject"><?= $this->escapeHtml($linktopic)?></a>
			<br />
			<? endforeach; ?>
		  <? endif; ?>
		</td>
	  </tr>
	  <? endif; ?>
-->
	<?
		$openUrl = $this->openUrl($this->driver, 'record');
		$openUrlActive = $openUrl->isActive();
		// Account for replace_other_urls setting
		$urls = $this->record($this->driver)->getLinkDetails($openUrlActive);
	  ?>
	  <? if (!empty($urls) || $openUrlActive): ?>
	  <tr>
		<th><?=$this->transEsc('Online Access')?>: </th>
		<td>
		  <? foreach ($urls as $current): ?>
			<? if($this->driver->getRegExpr($this->escapeHtml($current['desc']), $collectionType,$this->driver->getCollectionType()[0])): ?>																																			
			<a href="<?=$this->escapeHtmlAttr($this->proxyUrl($current['url']))?>"><?=($current['url'] == $current['desc']) ? $this->transEsc('Get full text') : $this->escapeHtml($current['desc'])?></a><br/>
			<? else: ?>
			  <span><?=$this->transEsc("Not available")?></span></br>
			<?endif;?>
		  <? endforeach; ?>
		  <? if ($openUrlActive): ?>
			<?=$openUrl->renderTemplate()?><br/>
		  <? endif; ?>
		</td>
	  </tr>
	  <? endif; ?>

 <? $recordLinks = $this->driver->getAllRecordLinks(); ?>
	  <? if(!empty($recordLinks)): ?>
		<tr>
		  <th><?=$this->transEsc('Related Items')?>:</th>
		  <td>
			<? foreach ($recordLinks as $recordLink): ?>
			  <?=$this->transEsc($recordLink['title'])?>:
			  <a href="<?=$this->recordLink()->related($recordLink['link'])?>"><?=$this->escapeHtml($recordLink['value'])?></a><br />
			<? endforeach; ?>
			<? /* if we have record links, display relevant explanatory notes */
			  $related = $this->driver->getRelationshipNotes();
			  if (!empty($related)): ?>
				<? foreach ($related as $field): ?>
				  <?=$this->escapeHtml($field)?><br/>
				<? endforeach; ?>
			<? endif; ?>
		  </td>
		</tr>
	  <? endif; ?>

	  <? if ($this->usertags()->getMode() !== 'disabled'): ?>
		<? $tagList = $this->driver->getTags(); ?>
		<tr>
		  <th><?=$this->transEsc('Tags')?>: </th>
		  <td>
			<span class="pull-right">
			  <i class="fa fa-plus"></i> <a id="tagRecord" class="modal-link" href="<?=$this->recordLink()->getActionUrl($this->driver, 'AddTag')?>" title="<?=$this->transEsc('Add Tag')?>"><?=$this->transEsc('Add Tag')?></a>
			</span>
			<div id="tagList">
			  <? if (count($tagList) > 0): ?>
				<? $i = 0; foreach ($tagList as $tag): ?><?=($i++ == 0)?'':', '?><a href="<?=$this->url('tag-home')?>?lookfor=<?=urlencode($tag->tag)?>"><?=$this->escapeHtml($tag->tag)?></a> (<?=$this->escapeHtml($tag->cnt)?>)<? endforeach; ?>
			  <? else: ?>
				<?=$this->transEsc('No Tags')?>, <?=$this->transEsc('Be the first to tag this record')?>!
			  <? endif; ?>
			</div>
		  </td>
		</tr>
	  <? endif; ?>
	</table>
	<?/* End Main Details */?>
	
<!-- END MAIN DETAILS TABLE -->
	
  </div>
</div>
</br></br>

<script>
function showAllHoldings() {
$( ".hidden_holdings" ).each(function() {
  $( this ).removeClass( "hidden_holdings" ).addClass( "hidden_holdings3" );
});

$( "#div_show_more" ).each(function() {
  $( this ).addClass( "hidden" );
});
$( "#div_show_less" ).each(function() {
  $( this ).removeClass( "hidden" );
});
}

function showLessHoldings() {
$( ".hidden_holdings3" ).each(function() {
	
  $( this ).removeClass( "hidden_holdings3" ).addClass( "hidden_holdings" );
  
  $( "#div_show_less" ).each(function() {
  $( this ).addClass( "hidden" );
});
$( "#div_show_more" ).each(function() {
  $( this ).removeClass( "hidden" );
});
});

}
</script>
